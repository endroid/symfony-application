#!/usr/bin/env bash

set -e

git init

curl -sS https://getcomposer.org/installer | php -- --filename=composer --version=2.0.0-RC2

./composer config minimum-stability dev
./composer config prefer-stable true
./composer config extra.symfony.allow-contrib true
./composer config platform.php 7.4

# Use source when installing personal libraries
sed -i -e s#\"[*]\":#\"endroid/*\":\"source\",\"*\":#g composer.json

./composer config repositories.play-bundle vcs git@github.com:endroid/play-bundle.git
./composer config repositories.adventure-bundle vcs git@github.com:endroid/adventure-bundle.git

./composer require \
    doctrine/doctrine-fixtures-bundle \
    endroid/adventure-bundle:dev-master \
    endroid/anonymizer:dev-master \
    endroid/asset:dev-master \
    endroid/calendar:dev-master \
    endroid/cm-sms:dev-master \
    endroid/cm-sms-bundle:dev-master \
    endroid/composer-message:dev-master \
    endroid/data-sanitize:dev-master \
    endroid/data-sanitize-bundle:dev-master \
    endroid/data-sanitize-demo-bundle:dev-master \
    endroid/embed:dev-master \
    endroid/finance-bundle:dev-master \
    endroid/flusher:dev-master \
    endroid/guide:dev-master \
    endroid/guide-bundle:dev-master \
    endroid/image-placeholder:dev-master \
    endroid/import:dev-master \
    endroid/import-bundle:dev-master \
    endroid/import-demo-bundle:dev-master \
    endroid/installer:dev-master \
    endroid/pdf:dev-master \
    endroid/play-bundle:dev-master \
    endroid/priority-shuffle-random:dev-master \
    endroid/property-access:dev-master \
    endroid/qr-code:4.0.x-dev \
    endroid/qr-code-bundle:4.0.x-dev \
    endroid/quality:dev-master \
    endroid/simple-spreadsheet:dev-master \
    endroid/soccer-calendar:dev-master \
    endroid/soccer-calendar-bundle:dev-master \
    endroid/soccer-data:dev-master \
    endroid/sudoku:dev-master \
    endroid/teleporter:dev-master \
    endroid/tile:dev-master \
    endroid/tile-bundle:dev-master \
    knplabs/knp-snappy-bundle \
    predis/predis \
    snc/redis-bundle \
    symfony/messenger \
    --no-update

./composer update --no-progress --no-interaction

bin/console doctrine:database:drop --if-exists --force
bin/console doctrine:database:create
bin/console doctrine:migrations:diff

bin/setup
