#!/usr/bin/env bash

set -e

git init

curl -sS https://getcomposer.org/installer | php -- --filename=composer

composer config extra.symfony.allow-contrib true

# Use source when installing personal libraries
sed -i -e s#\"[*]\":#\"endroid/*\":\"source\",\"*\":#g composer.json

{## if play ##}
composer config repositories.play-bundle vcs git@github.com:endroid/play-bundle.git
composer config repositories.adventure-bundle vcs git@github.com:endroid/adventure-bundle.git
{## endif ##}

composer require \
    api-platform/api-pack \
    doctrine/doctrine-fixtures-bundle \
    doctrine/doctrine-migrations-bundle \
    easycorp/easyadmin-bundle \
{## if play ##}
    endroid/adventure-bundle:dev-master \
{## endif ##}
    endroid/asset:dev-master \
    endroid/calendar:dev-master \
    endroid/cm-sms:dev-master \
    endroid/cm-sms-bundle:dev-master \
    endroid/data-sanitize:dev-master \
    endroid/data-sanitize-bundle:dev-master \
    endroid/data-sanitize-demo-bundle:dev-master \
    endroid/documenter:dev-master \
    endroid/embed:dev-master \
    endroid/flusher:dev-master \
    endroid/flusher-bundle:dev-master \
    endroid/form-bundle:dev-master \
    endroid/guide:dev-master \
    endroid/guide-bundle:dev-master \
    endroid/guidelines:dev-master \
    endroid/image-placeholder:dev-master \
    endroid/import:dev-master \
    endroid/import-bundle:dev-master \
    endroid/import-demo-bundle:dev-master \
    endroid/installer:dev-master \
    endroid/pdf:dev-master \
{## if play ##}
    endroid/play-bundle:dev-master \
{## endif ##}
    endroid/priority-shuffle-random:dev-master \
    endroid/property-access:dev-master \
    endroid/qr-code:dev-master \
    endroid/qr-code-bundle:dev-master \
    endroid/simple-excel:dev-master \
    endroid/soccer-calendar:dev-master \
    endroid/soccer-calendar-bundle:dev-master \
    endroid/soccer-data:dev-master \
    endroid/sudoku:dev-master \
    endroid/sudoku-bundle:dev-master \
    endroid/teleporter:dev-master \
    endroid/tile:dev-master \
    endroid/tile-bundle:dev-master \
    endroid/twitter:dev-master \
    friendsofsymfony/ckeditor-bundle \
    friendsofsymfony/elastica-bundle \
    friendsofsymfony/user-bundle \
    gesdinet/jwt-refresh-token-bundle \
    helios-ag/fm-elfinder-bundle \
    hwi/oauth-bundle \
    knplabs/knp-snappy-bundle \
    nelmio/cors-bundle \
    nelmio/security-bundle \
    php-ai/php-ml \
    php-http/httplug-bundle:1.13.1 \
    predis/predis \
    pusher/pusher-php-server \
    ramsey/uuid-doctrine \
    ruflin/elastica \
    sensiolabs/security-checker \
    snc/redis-bundle \
    sonata-project/doctrine-orm-admin-bundle \
    symfony/dotenv \
    symfony/lock \
    symfony/messenger \
    symfony/monolog-bundle \
    symfony/templating \
    webonyx/graphql-php \
    --no-update -q

composer require \
    behat/mink-extension \
    behat/mink-goutte-driver \
    behat/mink-selenium2-driver \
    behat/symfony2-extension \
    behatch/contexts \
    friendsofphp/php-cs-fixer \
    phpmd/phpmd \
    phpstan/phpstan \
    rpkamp/mailhog-behat-extension \
    rpkamp/mailhog-mink-behat-context \
    --no-update --dev -q

php -d memory_limit=-1 composer update --no-progress -n

rm -rf features/demo.feature

bin/console doctrine:database:drop --if-exists --force -q
bin/console doctrine:database:create -q
bin/console doctrine:migrations:diff -q

# Allow fixtures in production environment and server commands in test environment
sed -i -e 's/Doctrine\\Bundle\\FixturesBundle\\DoctrineFixturesBundle::class => \[\x27dev\x27 => true, \x27test\x27 => true\],/Doctrine\\Bundle\\FixturesBundle\\DoctrineFixturesBundle::class => \[\x27all\x27 => true\],/g' config/bundles.php
sed -i -e 's/Symfony\\Bundle\\WebServerBundle\\WebServerBundle::class => \[\x27dev\x27 => true\],/Symfony\\Bundle\\WebServerBundle\\WebServerBundle::class => \[\x27all\x27 => true\],/g' config/bundles.php

# Clear redis caches except sessions
sed -i 's/"cache:clear": "symfony-cmd",/"cache:clear": "symfony-cmd",\n\t\t\t"doctrine:cache:clear-metadata": "symfony-cmd",\n\t\t\t"doctrine:cache:clear-result": "symfony-cmd",\n\t\t\t"doctrine:cache:clear-query": "symfony-cmd",/' composer.json

bin/setup

rm -rf src/DataFixtures/AppFixtures.php

vendor/bin/php-cs-fixer fix src
vendor/bin/php-cs-fixer fix vendor/endroid
